<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AEMO Data Explorer</title>
</head>
<body>
<style>
    .heatmap {
        width: 576px;
        line-height: 10px;
    }

    .demand-interval {
        height: 10px;
        width: 10px;
        border: 1px solid white;
        display: inline-block;
    }
</style>

<script type="text/javascript" src="js/d3.v3.js"></script>
<script type="text/javascript" src="js/colorbrewer.js"></script>
<script>
    var data = [];
    var regionId = getParameterByName("regionid")

    var oReq = new XMLHttpRequest();
    if (regionId) {
        oReq.open("GET", "data/" + regionId + "-actual-operational-demand.bin", true);
    } else {
        oReq.open("GET", "data/all.bin", true);
    }
    oReq.responseType = "arraybuffer";

    oReq.onload = function (oEvent) {
        var arrayBuffer = oReq.response; // Note: not oReq.responseText
        if (arrayBuffer) {

            var byteArray = new DataView(arrayBuffer);
            var str = "";
            for (var i = 0; i < byteArray.byteLength / 4; i++) {
                var demand = byteArray.getInt32(i * 4, false);
                data.push(demand);
            }
            var body = d3.select("body");
            var heatmapCanvas = body.append("canvas")
                    .attr("width", 2000)
                    .attr("height", 500);

            var context = heatmapCanvas.node().getContext("2d");

            var colorScale = d3.scale.quantile()
                    .domain([d3.min(data, function(val) {
                        console.log(val);
                                return val > 0 ? val : null;
                            }), d3.max(data)])
                    .range(d3.range(11));


            data.forEach(function (d, i) {
                if (d == 0) {
                    return;
                }
                var y = (i % 48) * 6;
                var x = Math.floor(i / 48) * 11;
                var color = colorbrewer.Spectral[11][colorScale(d)];
                context.beginPath();
                context.rect(x, y, 10, 5);
                context.fillStyle = color;
                context.fill();
                context.closePath();
            });


        }
    };

    oReq.send(null);

    function pad(num, size) {
        var s = num + "";
        while (s.length < size) s = "0" + s;
        return s;
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
</script>

</body>
</html>